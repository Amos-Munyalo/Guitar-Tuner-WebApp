<!DOCTYPE html>
<html>

<head>
    <title>Upload Video</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Firebase JavaScript SDK -->

</head>

<body>
    <h1>Video Upload</h1>
    <input type="file" id="file-input" accept="video/*">
    <button id="upload-button">Upload</button>

    <div id="video-container" class="video-container flex flex-col w-72 h-72 gap-5"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
        import { onValue, getDatabase, set, ref as databaseRef } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js"
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";


        const firebaseConfig = {
            apiKey: "AIzaSyADlFpFRYXFTTnYtdPWaS5FpylahOkyTek",
            authDomain: "guitar-tunner-9bd54.firebaseapp.com",
            projectId: "guitar-tunner-9bd54",
            storageBucket: "guitar-tunner-9bd54.appspot.com",
            messagingSenderId: "534214805325",
            appId: "1:534214805325:web:8941f0e10a240d5d085904",
            measurementId: "G-4F13BLVGNM"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const auth = getAuth(app)
        const db = getDatabase(app)

        const user = auth.currentUser;
        // File upload function

        function generateCustomId(length = 8) {
            const alphanumeric = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let customId = '';

            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * alphanumeric.length);
                customId += alphanumeric.charAt(randomIndex);
            }

            return customId;
        }

        async function uploadVideo(file) {
            try {
                const user = auth.currentUser

                if (user) {
                    const userId = user.uid
                    console.log(userId)

                    const videoId = generateCustomId();
                    const storageRef = ref(storage, `videos/${userId}/${file.name}`);
                    await uploadBytes(storageRef, file);

                    const videoMetadata = {
                        videoId: videoId,
                        fileName: file.name,
                        url: `https://firebasestorage.googleapis.com/v0/b/${storageRef.bucket}/o/${encodeURIComponent(storageRef.fullPath)}?alt=media`,
                        uploaderId: userId,

                    }

                    // set(databaseRef(db, 'Users/' + user.uid), { videoMetadata })
                    set(databaseRef(db, 'Users/' + user.uid + '/videos/' + videoMetadata.videoId), { videoMetadata })
                        .then(() => {
                            console.log('Data set successful')
                        })
                        .catch((error) => {
                            console.log(error)
                        }
                        )

                    console.log('Video uploaded successfully!');

                } else {
                    console.log('User not logged in')
                }



            } catch (error) {
                console.error('Error uploading video:', error);
            }
        }

        function fetchAndDisplayVideos() {
            const user = auth.currentUser;

            if (user) {
                const userId = user.uid;


                const userRef = databaseRef(db, `Users/${userId}/userData`);
                onValue(userRef, (snapshot) => {
                    const userData = snapshot.val();
                    const userName = userData.firstName;

                    console.log('User name:', userName);
                })

                const videosRef = databaseRef(db, `Users/${userId}/videos`);

                onValue(videosRef, (snapshot) => {
                    const videos = snapshot.val();
                    const videoContainer = document.getElementById('video-container');

                    // Clear previous videos
                    videoContainer.innerHTML = '';

                    if (videos) {
                        // Display the videos
                        for (const videoId in videos) {
                            const videoMetadata = videos[videoId].videoMetadata;

                            // Create a video element for each video
                            const videoElement = document.createElement('video');
                            videoElement.src = videoMetadata.url;
                            videoElement.controls = true;

                            // Append the video element to the container
                            videoContainer.appendChild(videoElement);
                        }
                    } else {
                        console.log('No videos found')
                    }
                })
            }
            // } else {
            //     console.log('User not logged in');
            // }
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                // Call fetchAndDisplayVideos when the user is logged in
                fetchAndDisplayVideos();
            } else {
                console.log('User not logged in');
            }
        });

        // Example usage
        const fileInput = document.getElementById('file-input');

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
        });

        const uploadButton = document.getElementById('upload-button');

        uploadButton.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (file) {
                uploadVideo(file);
                fetchAndDisplayVideos()
            } else {
                console.log('No file selected.');
            }
        });

        window.addEventListener('load', fetchAndDisplayVideos)

        let timeOut;
        function resetTimeout() {
            clearTimeout(timeOut);
            timeOut = setTimeout(logout, 60000)
        }

        function logout() {
            auth.signOut().then(() => {
                sessionStorage.removeItem('userAuthenticated')
                window.location.href = 'login.html'
            })
                .catch((error) => {
                    console.log('Error logging out', error);
                })
        }

        document.addEventListener('mousemove', resetTimeout);
        document.addEventListener('keypress', resetTimeout);
        document.addEventListener('mousedown', resetTimeout);

        resetTimeout();
    </script>
</body>

</html>